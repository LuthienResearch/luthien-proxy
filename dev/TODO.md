# TODO

## High Priority

- [ ] Update README post v2-migration
- [ ] **Verify UI monitoring endpoints functionality** - Check which UI endpoints are working and refactor as needed:
  - Test `/debug/diff` - diff viewer with side-by-side comparisons
  - Test `/activity/monitor` - real-time activity stream
  - Test `/debug/calls/{call_id}/diff` - API endpoint for diffs
  - Test `/debug/calls` - recent calls listing
  - Test `/activity/stream` - SSE endpoint
  - Verify transaction recorder is storing both original and final requests/responses
  - Check if debug routes are properly mounted in main.py
  - Refactor/fix any broken endpoints
- [ ] **Factor out common gateway route logic** - `/v1/chat/completions` and `/v1/messages` endpoints have significant duplication:
  - Both create the same pipeline dependencies (recorder, executor, formatter, orchestrator)
  - Both call `process_request()` and `record_request()` identically
  - Both handle streaming/non-streaming with identical patterns
  - Extract common pipeline setup into `_create_pipeline_components()` helper function
  - Would reduce code duplication from ~90 lines each to ~20 lines each
  - Main differences are: request format conversion (Anthropic→OpenAI) and response format conversion (OpenAI→Anthropic)
- [ ] **Make policy selection easier for e2e testing** - Allow temporary policy specification without modifying config files:
- [ ] **Policy API: Prevent common streaming mistakes** - Make it easier for policy writers to avoid streaming bugs:
  - Consider base class that auto-forwards chunks by default (opt-in buffering instead of opt-in forwarding)
  - Provide better helper functions for common patterns (send_content, send_blocked_message, etc.)
  - Add validation/warnings when policies don't forward chunks
  - Consider dependency injection for chunk creation to ensure correct types
- [ ] **Format blocked messages for readability** - Current blocked messages are ugly (backslashes, no newlines). Need to:
  - Pretty-print JSON tool arguments
  - Add proper line breaks in explanations
  - Consider terminal/web formatting differences
- [ ] Add security documentation for dynamic policy loading mechanism (POLICY_CONFIG) ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445270602))
- [ ] Verify all environment variables are documented in README and .env.example ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445270602))
- [ ] Add input validation: max request size and message count limits ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] **Fix assertion usage in production code** - Replace `assert` statements with proper error handling:
  - `simple_policy.py:69, 92` - Replace assertions with explicit `if` checks and raise proper exceptions
  - Assertions can be disabled with Python's `-O` flag, making them unreliable for production
  - Use `ValueError` or custom exceptions instead
- [ ] **Replace magic numbers with named constants**:
  - `queue_size: int = 10000` (policy_orchestrator.py:49) - should be named constant `DEFAULT_QUEUE_SIZE`
  - `max_chunks_queued: int = 4096` (transaction_recorder.py:19) - should be configurable via env var
  - Truncation length `[:200]` (policy_orchestrator.py:188) - should be `LOG_TRUNCATION_LENGTH`
  - Document rationale for queue sizes and benchmark for typical workloads
- [ ] **Improve error handling for OpenTelemetry spans** - Add defensive coding for when OTEL is not configured:
  - `DefaultObservabilityContext` assumes span is always valid (context.py:78-88)
  - Add checks: `if self.span and self.span.is_recording(): self.span.set_attribute(...)`
- [ ] **Review LiteLLMClient instantiation pattern** - Currently creates new instance per request (gateway_routes.py:134, 227):
  - Check if LiteLLM needs connection pooling or has startup overhead
  - Consider making it a singleton or FastAPI app state dependency
- [ ] **Add logging for chunk truncation** - Silent truncation should be more visible:
  - Log at ERROR level when chunks are truncated (transaction_recorder.py:96-101)
  - Add metrics/alerts for frequent truncation
  - Consider circuit breaking on sustained truncation
- [ ] **Add timeout configuration documentation** - Document why no timeout is set in gateway routes or make it configurable:
  - `PolicyExecutor(recorder=recorder)` uses default timeout of `None` (gateway_routes.py:117)
  - Either document rationale or add environment variable configuration
- [ ] Move "v2" code out of v2/
- [ ] Consolidate/organize utility/helper functions (see policies/utils.py)
- [ ] thinking and verbosity model flags not respected
- [ ] write SimpleToolCallJudge policy for pedagogical purposes
- [ ] improve docstrings for SimplePolicy

## Medium Priority

- [ ] **Add missing integration tests for error recovery paths**:
  - Database failure scenarios (what happens when db_pool connection fails mid-request?)
  - Redis failure scenarios (event_publisher connection errors during event emission)
  - Policy timeout recovery (verify system recovers gracefully after policy timeout)
  - Network failures during LLM calls
  - Malformed response handling from upstream providers
- [ ] **Improve module-level docstrings** - Replace placeholder docstrings with descriptive ones:
  - `transaction_recorder.py:4` has `"""Module docstring."""` - should describe purpose
  - Follow pattern from well-documented modules like `anthropic_sse_assembler.py`
- [ ] **Audit all tests for unjustified conditional logic** - Review all test files (unit, integration, e2e) and remove conditional logic that checks for optional behavior. Tests should assert expected behavior, not conditionally validate. Exceptions: helper functions for parsing, format validation logic, legitimate expected variance in responses. Reference: test_streaming_chunk_structure.py cleanup as example.
- [ ] remove unnecessary string-matching test conditions (e.g. matching exception messages)
- [ ] call_id -> transaction_id (rename throughout codebase for consistency)
- [ ] Revisit ignored pyright issues
- [ ] Make filtering on the activity monitor easier and more intuitive
- [ ] Add rate limiting middleware (slowapi or custom FastAPI middleware) ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Implement circuit breaker for upstream calls ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Add Prometheus metrics endpoint ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Implement proper task tracking for event publisher (replace fire-and-forget) ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Add integration tests for error recovery paths ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Factor out env var logic into centralized config
- [ ] Add OpenAPI/Swagger documentation for V2 gateway ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445270602))
- [ ] Document production deployment best practices ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445270602))
- [ ] Add resource limits to docker-compose.yaml (mem_limit, cpus) ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))

## Low Priority / Future Work

- [ ] **Review and test observability functionality** - Verify observability stack is working correctly:
  - Test trace collection and visualization in Grafana
  - Verify activity monitor is receiving events
  - Check diff viewer functionality
  - Validate log-trace correlation
  - Consider consolidating the three observability docs (OBSERVABILITY_DEMO, VIEWING_TRACES_GUIDE, observability-v2) if there's significant overlap
- [ ] 99% unit test coverage (currently 81%, focus on critical paths first) ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Add config schema validation (Pydantic model for policy_config.yaml) ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Add request/response size limits ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Implement adaptive timeout based on model type ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Add policy composition (chaining multiple policies) ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Expose database connection pooling configuration (pool size, timeout) ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Add cache headers to static files mount ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Standardize on docstrings (currently mixed ABOUTME/docstrings) ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Extract magic numbers to named constants (timeouts, truncation lengths) ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Consider stricter type checking (pyright "standard" or "strict" mode) ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445272764))
- [ ] Add health check endpoint with degraded state reporting ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445270602))
- [ ] Minimize type: ignore flags
- [ ] Load testing with multiple concurrent streams ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445270602))
- [ ] Memory leak detection for long-running streams ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445270602))
- [ ] Redis pub/sub performance testing under high event volume ([review](https://github.com/LuthienResearch/luthien-proxy/pull/46#issuecomment-3445270602))
