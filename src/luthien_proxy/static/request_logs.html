<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Request/Response Logs</title>
    <link rel="stylesheet" href="/static/nav.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a1a; color: #e0e0e0; padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        header { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #333; }
        h1 { font-size: 28px; font-weight: 600; margin-bottom: 8px; }
        .subtitle { color: #888; font-size: 14px; }

        /* Filters */
        .filters {
            display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end;
            margin-bottom: 24px; padding: 16px; background: #222;
            border: 1px solid #333; border-radius: 8px;
        }
        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-group label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-group input, .filter-group select {
            padding: 8px 12px; border: 1px solid #444; border-radius: 6px;
            background: #2a2a2a; color: #e0e0e0; font-size: 13px;
        }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #60a5fa; }
        button {
            padding: 8px 20px; border: 1px solid #444; border-radius: 6px;
            background: #2a2a2a; color: #e0e0e0; font-size: 13px;
            cursor: pointer; transition: all 0.2s; font-weight: 500;
        }
        button:hover { background: #333; border-color: #555; }
        button.primary { background: #2563eb; border-color: #2563eb; color: white; }
        button.primary:hover { background: #1d4ed8; }

        /* Log table */
        .log-table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
        .log-table th {
            text-align: left; padding: 10px 12px; background: #2a2a2a;
            border-bottom: 2px solid #444; font-size: 12px; color: #888;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .log-table td {
            padding: 10px 12px; border-bottom: 1px solid #333;
            font-size: 13px; cursor: pointer;
        }
        .log-table tr:hover td { background: #252525; }
        .badge {
            display: inline-block; padding: 3px 8px; border-radius: 4px;
            font-size: 11px; font-weight: 600; text-transform: uppercase;
        }
        .badge.inbound { background: #1e3a5f; color: #60a5fa; }
        .badge.outbound { background: #1a4d1a; color: #4ade80; }
        .badge.status-2xx { background: #1a4d1a; color: #4ade80; }
        .badge.status-4xx { background: #4d3a1a; color: #f59e0b; }
        .badge.status-5xx { background: #4d1a1a; color: #f87171; }
        .mono { font-family: "Monaco", "Menlo", monospace; font-size: 12px; }
        .truncate { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Detail panel */
        .detail-panel {
            background: #222; border: 1px solid #333; border-radius: 8px;
            margin-bottom: 24px; overflow: hidden;
        }
        .detail-header {
            padding: 16px; background: #2a2a2a; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .detail-header h2 { font-size: 18px; font-weight: 600; }
        .detail-tabs { display: flex; gap: 8px; margin: 0 16px; border-bottom: 1px solid #333; }
        .detail-tab {
            padding: 10px 16px; cursor: pointer; font-size: 13px; color: #888;
            border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .detail-tab:hover { color: #e0e0e0; }
        .detail-tab.active { color: #60a5fa; border-bottom-color: #60a5fa; }
        .detail-content { padding: 16px; }
        .detail-section { margin-bottom: 16px; }
        .detail-section h3 {
            font-size: 13px; color: #888; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 8px;
        }
        .json-view {
            background: #1a1a1a; border: 1px solid #333; border-radius: 6px;
            padding: 12px; font-family: "Monaco", "Menlo", monospace;
            font-size: 12px; line-height: 1.6; max-height: 400px;
            overflow-y: auto; white-space: pre-wrap; word-break: break-word;
        }
        .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .meta-item {
            background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 10px;
        }
        .meta-label { font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 4px; }
        .meta-value { font-family: "Monaco", "Menlo", monospace; font-size: 13px; }

        /* Side-by-side diff */
        .side-by-side { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .column { background: #222; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
        .column-header {
            padding: 10px 14px; background: #2a2a2a; font-weight: 600;
            font-size: 13px; border-bottom: 1px solid #333;
        }
        .column-header.inbound { color: #60a5fa; }
        .column-header.outbound { color: #4ade80; }
        .column-content {
            padding: 12px; font-family: "Monaco", "Menlo", monospace;
            font-size: 12px; line-height: 1.6; max-height: 500px; overflow-y: auto;
            white-space: pre-wrap; word-break: break-word;
        }

        .pagination { display: flex; justify-content: center; gap: 12px; align-items: center; }
        .pagination button { padding: 6px 16px; }
        .page-info { color: #888; font-size: 13px; }
        .error { background: #4d1a1a; color: #f87171; padding: 12px; border-radius: 6px; margin-bottom: 16px; }
        .loading { text-align: center; padding: 40px; color: #888; }
        .empty { text-align: center; padding: 40px; color: #666; font-style: italic; }

        @media (max-width: 1024px) { .side-by-side { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav x-data="luthienNav" class="luthien-nav">
        <a href="/" class="nav-brand">Luthien</a>
        <template x-for="link in links" :key="link.href">
            <a :href="link.href" class="nav-link" :class="{ active: isActive(link.href) }" x-text="link.label"></a>
        </template>
        <div class="nav-spacer"></div>
        <a href="/auth/logout" class="nav-signout">Sign Out</a>
    </nav>

    <div class="container">
        <header>
            <h1>Request/Response Logs</h1>
            <p class="subtitle">HTTP-level request and response logging for proxy debugging</p>
        </header>

        <div class="filters">
            <div class="filter-group">
                <label>Direction</label>
                <select id="filterDirection">
                    <option value="">All</option>
                    <option value="inbound">Inbound</option>
                    <option value="outbound">Outbound</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Endpoint</label>
                <select id="filterEndpoint">
                    <option value="">All</option>
                    <option value="/v1/chat/completions">/v1/chat/completions</option>
                    <option value="/v1/messages">/v1/messages</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Model</label>
                <input type="text" id="filterModel" placeholder="e.g. gpt-4o" style="width: 140px;" />
            </div>
            <div class="filter-group">
                <label>Session ID</label>
                <input type="text" id="filterSession" placeholder="Session ID" style="width: 200px;" />
            </div>
            <div class="filter-group">
                <label>Status</label>
                <input type="number" id="filterStatus" placeholder="e.g. 200" style="width: 80px;" />
            </div>
            <div class="filter-group">
                <label>Search Body</label>
                <input type="text" id="filterSearch" placeholder="Search in body..." style="width: 200px;" />
            </div>
            <div class="filter-group" style="align-self: flex-end;">
                <button class="primary" onclick="loadLogs()">Search</button>
            </div>
        </div>

        <div id="errorContainer"></div>
        <div id="detailContainer"></div>
        <div id="logContainer"><div class="loading">Loading...</div></div>
        <div id="paginationContainer"></div>
    </div>

    <script>
        let currentOffset = 0;
        const PAGE_SIZE = 50;

        document.addEventListener('DOMContentLoaded', () => loadLogs());

        async function loadLogs() {
            const params = new URLSearchParams();
            params.set('limit', PAGE_SIZE);
            params.set('offset', currentOffset);

            const direction = document.getElementById('filterDirection').value;
            const endpoint = document.getElementById('filterEndpoint').value;
            const model = document.getElementById('filterModel').value.trim();
            const session = document.getElementById('filterSession').value.trim();
            const status = document.getElementById('filterStatus').value.trim();
            const search = document.getElementById('filterSearch').value.trim();

            if (direction) params.set('direction', direction);
            if (endpoint) params.set('endpoint', endpoint);
            if (model) params.set('model', model);
            if (session) params.set('session_id', session);
            if (status) params.set('status', status);
            if (search) params.set('search', search);

            const container = document.getElementById('logContainer');
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = '';
            container.innerHTML = '<div class="loading">Loading logs...</div>';

            try {
                const response = await fetch(`/api/request-logs?${params}`, { credentials: 'same-origin' });
                if (response.status === 403) {
                    window.location.href = '/login?error=required&next=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || `HTTP ${response.status}`);
                }
                const data = await response.json();
                renderLogs(data);
                renderPagination(data);
            } catch (error) {
                container.innerHTML = '';
                errorContainer.innerHTML = `<div class="error">Failed to load logs: ${error.message}</div>`;
            }
        }

        function renderLogs(data) {
            const container = document.getElementById('logContainer');
            if (data.logs.length === 0) {
                container.innerHTML = '<div class="empty">No request logs found. Enable logging with ENABLE_REQUEST_LOGGING=true.</div>';
                return;
            }

            let html = `<table class="log-table">
                <thead><tr>
                    <th>Time</th><th>Direction</th><th>Endpoint</th>
                    <th>Model</th><th>Status</th><th>Duration</th>
                    <th>Transaction</th>
                </tr></thead><tbody>`;

            data.logs.forEach(log => {
                const time = new Date(log.started_at).toLocaleString();
                const dirClass = log.direction;
                const statusClass = log.response_status ? (log.response_status < 400 ? 'status-2xx' : log.response_status < 500 ? 'status-4xx' : 'status-5xx') : '';
                const duration = log.duration_ms ? `${log.duration_ms.toFixed(0)}ms` : '-';
                const txnShort = log.transaction_id.substring(0, 8);

                html += `<tr onclick="loadDetail('${log.transaction_id}')">
                    <td class="mono">${escapeHtml(time)}</td>
                    <td><span class="badge ${dirClass}">${log.direction}</span></td>
                    <td class="mono truncate">${escapeHtml(log.endpoint || '-')}</td>
                    <td class="mono">${escapeHtml(log.model || '-')}</td>
                    <td><span class="badge ${statusClass}">${log.response_status || '-'}</span></td>
                    <td class="mono">${duration}</td>
                    <td class="mono" title="${log.transaction_id}">${txnShort}...</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderPagination(data) {
            const container = document.getElementById('paginationContainer');
            const totalPages = Math.ceil(data.total / PAGE_SIZE);
            const currentPage = Math.floor(currentOffset / PAGE_SIZE) + 1;

            if (totalPages <= 1) { container.innerHTML = ''; return; }

            container.innerHTML = `<div class="pagination">
                <button ${currentOffset === 0 ? 'disabled' : ''} onclick="changePage(-1)">Previous</button>
                <span class="page-info">Page ${currentPage} of ${totalPages} (${data.total} total)</span>
                <button ${currentOffset + PAGE_SIZE >= data.total ? 'disabled' : ''} onclick="changePage(1)">Next</button>
            </div>`;
        }

        function changePage(delta) {
            currentOffset = Math.max(0, currentOffset + delta * PAGE_SIZE);
            loadLogs();
        }

        async function loadDetail(transactionId) {
            const container = document.getElementById('detailContainer');
            container.innerHTML = '<div class="loading">Loading transaction details...</div>';

            try {
                const response = await fetch(`/api/request-logs/${transactionId}`, { credentials: 'same-origin' });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || `HTTP ${response.status}`);
                }
                const data = await response.json();
                renderDetail(data);
            } catch (error) {
                container.innerHTML = `<div class="error">Failed to load details: ${error.message}</div>`;
            }
        }

        function renderDetail(data) {
            const container = document.getElementById('detailContainer');
            let html = `<div class="detail-panel">
                <div class="detail-header">
                    <h2>Transaction ${data.transaction_id.substring(0, 12)}...</h2>
                    <button onclick="document.getElementById('detailContainer').innerHTML=''">Close</button>
                </div>
                <div class="detail-tabs">
                    <div class="detail-tab active" onclick="showTab(this, 'overview')">Overview</div>
                    <div class="detail-tab" onclick="showTab(this, 'diff')">Diff View</div>
                    <div class="detail-tab" onclick="showTab(this, 'inbound')">Inbound</div>
                    <div class="detail-tab" onclick="showTab(this, 'outbound')">Outbound</div>
                </div>`;

            // Overview tab
            html += `<div class="detail-content tab-content" id="tab-overview">`;
            html += '<div class="meta-grid">';
            html += metaItem('Transaction ID', data.transaction_id);
            html += metaItem('Session ID', data.session_id || '-');
            if (data.inbound) {
                html += metaItem('Model', data.inbound.model || '-');
                html += metaItem('Endpoint', data.inbound.endpoint || '-');
                html += metaItem('Streaming', data.inbound.is_streaming ? 'Yes' : 'No');
                html += metaItem('Inbound Duration', data.inbound.duration_ms ? `${data.inbound.duration_ms.toFixed(0)}ms` : '-');
            }
            if (data.outbound) {
                html += metaItem('Outbound Duration', data.outbound.duration_ms ? `${data.outbound.duration_ms.toFixed(0)}ms` : '-');
            }
            html += '</div></div>';

            // Diff tab
            html += `<div class="detail-content tab-content" id="tab-diff" style="display:none;">`;
            html += '<h3 style="margin-bottom:12px; color:#888;">Request Body: Inbound vs Outbound</h3>';
            html += '<div class="side-by-side">';
            html += `<div class="column"><div class="column-header inbound">Inbound Request (from client)</div>
                <div class="column-content">${formatJson(data.inbound?.request_body)}</div></div>`;
            html += `<div class="column"><div class="column-header outbound">Outbound Request (to backend)</div>
                <div class="column-content">${formatJson(data.outbound?.request_body)}</div></div>`;
            html += '</div>';
            html += '<h3 style="margin: 16px 0 12px; color:#888;">Response Body</h3>';
            html += '<div class="side-by-side">';
            html += `<div class="column"><div class="column-header inbound">Inbound Response (to client)</div>
                <div class="column-content">${formatJson(data.inbound?.response_body)}</div></div>`;
            html += `<div class="column"><div class="column-header outbound">Outbound Response (from backend)</div>
                <div class="column-content">${formatJson(data.outbound?.response_body)}</div></div>`;
            html += '</div></div>';

            // Inbound tab
            html += `<div class="detail-content tab-content" id="tab-inbound" style="display:none;">`;
            html += renderEntry(data.inbound, 'Inbound');
            html += '</div>';

            // Outbound tab
            html += `<div class="detail-content tab-content" id="tab-outbound" style="display:none;">`;
            html += renderEntry(data.outbound, 'Outbound');
            html += '</div>';

            html += '</div>';
            container.innerHTML = html;
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function renderEntry(entry, label) {
            if (!entry) return `<div class="empty">No ${label.toLowerCase()} data</div>`;
            let html = '';
            html += `<div class="detail-section"><h3>Request Headers</h3>
                <div class="json-view">${formatJson(entry.request_headers)}</div></div>`;
            html += `<div class="detail-section"><h3>Request Body</h3>
                <div class="json-view">${formatJson(entry.request_body)}</div></div>`;
            html += `<div class="detail-section"><h3>Response (Status: ${entry.response_status || '-'})</h3>
                <div class="json-view">${formatJson(entry.response_body)}</div></div>`;
            return html;
        }

        function showTab(el, tabId) {
            el.closest('.detail-panel').querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            el.closest('.detail-panel').querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById('tab-' + tabId).style.display = 'block';
        }

        function metaItem(label, value) {
            return `<div class="meta-item"><div class="meta-label">${escapeHtml(label)}</div>
                <div class="meta-value">${escapeHtml(String(value))}</div></div>`;
        }

        function formatJson(obj) {
            if (!obj) return '<span style="color:#666">null</span>';
            try {
                return escapeHtml(JSON.stringify(obj, null, 2));
            } catch { return escapeHtml(String(obj)); }
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Enter key triggers search
        document.querySelectorAll('.filters input').forEach(input => {
            input.addEventListener('keypress', e => { if (e.key === 'Enter') loadLogs(); });
        });
    </script>

    <script defer src="/static/vendor/alpine.min.js"></script>
    <script src="/static/nav.js"></script>
</body>
</html>
