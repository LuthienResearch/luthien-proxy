<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credentials - Luthien Proxy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #0a0a0a;
            color: #e5e5e5;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            color: #888;
        }

        .header-links {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .header-links a {
            color: #888;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        .header-links a:hover {
            color: #e5e5e5;
        }

        /* Sections */
        .section {
            background: #141414;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .section h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #e5e5e5;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #e5e5e5;
            margin-bottom: 6px;
        }

        .form-group .hint {
            display: block;
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 4px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            accent-color: #2563eb;
            width: 16px;
            height: 16px;
        }

        .radio-option span {
            font-size: 13px;
            color: #e5e5e5;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-option input[type="checkbox"] {
            accent-color: #2563eb;
            width: 16px;
            height: 16px;
        }

        .checkbox-option span {
            font-size: 13px;
            color: #e5e5e5;
        }

        .number-input {
            width: 120px;
            padding: 8px 12px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #e5e5e5;
            font-size: 13px;
            font-family: inherit;
        }

        .number-input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .config-meta {
            font-size: 12px;
            color: #666;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #262626;
        }

        /* Buttons */
        button {
            padding: 8px 16px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #e5e5e5;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        button:hover:not(:disabled) {
            border-color: #4ade80;
            background: #141414;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.primary {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
        }

        button.primary:hover:not(:disabled) {
            background: #1d4ed8;
            border-color: #1d4ed8;
        }

        button.danger {
            border-color: #f87171;
            color: #fca5a5;
        }

        button.danger:hover:not(:disabled) {
            background: #3d0a0a;
        }

        .button-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Status Messages */
        .status-message {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 16px;
            display: none;
        }

        .status-message.visible {
            display: block;
        }

        .status-message.success {
            background: #0a3d0a;
            border: 1px solid #4ade80;
            color: #4ade80;
        }

        .status-message.error {
            background: #3d0a0a;
            border: 1px solid #f87171;
            color: #fca5a5;
        }

        /* Table */
        .credentials-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .credentials-table th {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid #333;
            color: #888;
            font-weight: 500;
            font-size: 12px;
        }

        .credentials-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #1a1a1a;
            color: #e5e5e5;
        }

        .credentials-table tr:hover td {
            background: #161616;
        }

        .credentials-table .mono {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 12px;
        }

        .badge-valid {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            background: #0a3d0a;
            color: #4ade80;
        }

        .badge-invalid {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            background: #3d0a0a;
            color: #f87171;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 14px;
        }

        .table-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .table-actions .count {
            font-size: 13px;
            color: #888;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Credentials</h1>
                <p class="subtitle">Manage authentication modes and cached credentials</p>
            </div>
            <div class="header-links">
                <a href="/">Home</a>
                <a href="/activity/monitor">Activity Monitor</a>
                <a href="/policy-config">Policy Config</a>
                <a href="/auth/logout">Sign Out</a>
            </div>
        </header>

        <!-- Auth Configuration -->
        <div class="section" id="config-section">
            <h2>Auth Configuration</h2>
            <div id="config-loading" class="loading"><span class="spinner">&#x23F3;</span> Loading configuration...</div>
            <div id="config-form" style="display: none;">
                <div class="form-group">
                    <label>Auth Mode</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="auth_mode" value="proxy_key">
                            <span>proxy_key</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="auth_mode" value="passthrough">
                            <span>passthrough</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="auth_mode" value="both">
                            <span>both</span>
                        </label>
                    </div>
                    <span class="hint">proxy_key = single shared key, passthrough = forward user keys to LLM provider, both = accept either</span>
                </div>

                <div class="form-group">
                    <label class="checkbox-option">
                        <input type="checkbox" id="validate_credentials">
                        <span>Validate credentials against LLM provider</span>
                    </label>
                    <span class="hint">When enabled, passthrough keys are validated by making a test call to the provider</span>
                </div>

                <div class="form-group">
                    <label for="valid_ttl">Valid cache TTL (seconds)</label>
                    <input type="number" class="number-input" id="valid_ttl" min="0" step="1">
                    <span class="hint">How long to cache a successfully validated credential</span>
                </div>

                <div class="form-group">
                    <label for="invalid_ttl">Invalid cache TTL (seconds)</label>
                    <input type="number" class="number-input" id="invalid_ttl" min="0" step="1">
                    <span class="hint">How long to cache a failed validation result</span>
                </div>

                <div class="button-row">
                    <button class="primary" id="save-config-btn">Save Configuration</button>
                </div>

                <div class="config-meta" id="config-meta" style="display: none;"></div>
                <div class="status-message" id="config-status"></div>
            </div>
        </div>

        <!-- Cached Credentials -->
        <div class="section" id="credentials-section">
            <h2>Cached Credentials</h2>
            <div class="table-actions">
                <span class="count" id="credentials-count"></span>
                <div class="button-row">
                    <button id="refresh-btn">Refresh</button>
                    <button class="danger" id="invalidate-all-btn">Invalidate All</button>
                </div>
            </div>
            <div id="credentials-loading" class="loading"><span class="spinner">&#x23F3;</span> Loading credentials...</div>
            <div id="credentials-content" style="display: none;"></div>
            <div class="status-message" id="credentials-status"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/admin';

        function fetchApi(path, options = {}) {
            return fetch(API_BASE + path, {
                credentials: 'same-origin',
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...(options.headers || {}),
                },
            });
        }

        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = 'status-message visible ' + type;
            setTimeout(() => { el.className = 'status-message'; }, 5000);
        }

        function formatTimestamp(ts) {
            if (!ts) return '-';
            const date = new Date(typeof ts === 'number' ? ts * 1000 : ts);
            return date.toLocaleString();
        }

        // === Auth Config ===

        async function loadConfig() {
            try {
                const resp = await fetchApi('/auth/config');
                if (!resp.ok) throw new Error(await resp.text());
                const data = await resp.json();

                document.querySelector(`input[name="auth_mode"][value="${data.auth_mode}"]`).checked = true;
                document.getElementById('validate_credentials').checked = data.validate_credentials;
                document.getElementById('valid_ttl').value = data.valid_cache_ttl_seconds;
                document.getElementById('invalid_ttl').value = data.invalid_cache_ttl_seconds;

                const meta = document.getElementById('config-meta');
                if (data.updated_at || data.updated_by) {
                    meta.style.display = 'block';
                    const parts = [];
                    if (data.updated_at) parts.push('Updated: ' + formatTimestamp(data.updated_at));
                    if (data.updated_by) parts.push('By: ' + data.updated_by);
                    meta.textContent = parts.join(' | ');
                } else {
                    meta.style.display = 'none';
                }

                document.getElementById('config-loading').style.display = 'none';
                document.getElementById('config-form').style.display = 'block';
            } catch (e) {
                document.getElementById('config-loading').innerHTML =
                    '<span style="color: #fca5a5;">Failed to load config: ' + e.message + '</span>';
            }
        }

        async function saveConfig() {
            const btn = document.getElementById('save-config-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const authMode = document.querySelector('input[name="auth_mode"]:checked');
                const body = {
                    auth_mode: authMode ? authMode.value : null,
                    validate_credentials: document.getElementById('validate_credentials').checked,
                    valid_cache_ttl_seconds: parseInt(document.getElementById('valid_ttl').value, 10),
                    invalid_cache_ttl_seconds: parseInt(document.getElementById('invalid_ttl').value, 10),
                };

                const resp = await fetchApi('/auth/config', {
                    method: 'POST',
                    body: JSON.stringify(body),
                });

                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({ detail: resp.statusText }));
                    throw new Error(err.detail || resp.statusText);
                }

                const data = await resp.json();

                const meta = document.getElementById('config-meta');
                if (data.updated_at || data.updated_by) {
                    meta.style.display = 'block';
                    const parts = [];
                    if (data.updated_at) parts.push('Updated: ' + formatTimestamp(data.updated_at));
                    if (data.updated_by) parts.push('By: ' + data.updated_by);
                    meta.textContent = parts.join(' | ');
                }

                showStatus('config-status', 'Configuration saved successfully.', 'success');
            } catch (e) {
                showStatus('config-status', 'Failed to save: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Configuration';
            }
        }

        document.getElementById('save-config-btn').addEventListener('click', saveConfig);

        // === Cached Credentials ===

        async function loadCredentials() {
            try {
                const resp = await fetchApi('/auth/credentials');
                if (!resp.ok) throw new Error(await resp.text());
                const data = await resp.json();

                document.getElementById('credentials-count').textContent = data.count + ' cached credential' + (data.count !== 1 ? 's' : '');

                const content = document.getElementById('credentials-content');
                if (data.count === 0) {
                    content.innerHTML = '<div class="empty-state">No cached credentials</div>';
                } else {
                    let html = '<table class="credentials-table"><thead><tr>';
                    html += '<th>Hash</th><th>Status</th><th>Validated At</th><th>Last Used</th><th></th>';
                    html += '</tr></thead><tbody>';
                    for (const cred of data.credentials) {
                        const shortHash = cred.key_hash.length > 16 ? cred.key_hash.substring(0, 16) + '...' : cred.key_hash;
                        const badgeClass = cred.valid ? 'badge-valid' : 'badge-invalid';
                        const badgeText = cred.valid ? 'Valid' : 'Invalid';
                        html += '<tr>';
                        html += '<td class="mono" title="' + cred.key_hash + '">' + shortHash + '</td>';
                        html += '<td><span class="' + badgeClass + '">' + badgeText + '</span></td>';
                        html += '<td>' + formatTimestamp(cred.validated_at) + '</td>';
                        html += '<td>' + formatTimestamp(cred.last_used_at) + '</td>';
                        html += '<td><button class="danger" onclick="invalidateOne(\'' + cred.key_hash + '\')">Invalidate</button></td>';
                        html += '</tr>';
                    }
                    html += '</tbody></table>';
                    content.innerHTML = html;
                }

                document.getElementById('credentials-loading').style.display = 'none';
                content.style.display = 'block';
            } catch (e) {
                document.getElementById('credentials-loading').innerHTML =
                    '<span style="color: #fca5a5;">Failed to load credentials: ' + e.message + '</span>';
            }
        }

        async function invalidateOne(keyHash) {
            if (!confirm('Invalidate this credential?')) return;
            try {
                const resp = await fetchApi('/auth/credentials/' + encodeURIComponent(keyHash), { method: 'DELETE' });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({ detail: resp.statusText }));
                    throw new Error(err.detail || resp.statusText);
                }
                showStatus('credentials-status', 'Credential invalidated.', 'success');
                loadCredentials();
            } catch (e) {
                showStatus('credentials-status', 'Failed: ' + e.message, 'error');
            }
        }

        async function invalidateAll() {
            if (!confirm('Invalidate ALL cached credentials? Users will need to re-authenticate.')) return;
            try {
                const resp = await fetchApi('/auth/credentials', { method: 'DELETE' });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({ detail: resp.statusText }));
                    throw new Error(err.detail || resp.statusText);
                }
                const data = await resp.json();
                showStatus('credentials-status', data.message, 'success');
                loadCredentials();
            } catch (e) {
                showStatus('credentials-status', 'Failed: ' + e.message, 'error');
            }
        }

        document.getElementById('refresh-btn').addEventListener('click', loadCredentials);
        document.getElementById('invalidate-all-btn').addEventListener('click', invalidateAll);

        // === Init ===
        loadConfig();
        loadCredentials();
        setInterval(loadCredentials, 30000);
    </script>
</body>
</html>
