<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Global Activity Stream</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #0a0a0a;
        color: #e0e0e0;
        padding: 20px;
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #333;
      }

      h1 {
        font-size: 28px;
        font-weight: 300;
        color: #fff;
        margin-bottom: 10px;
      }

      .subtitle {
        color: #888;
        font-size: 14px;
      }

      .status-bar {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background: #151515;
        border-radius: 8px;
        align-items: center;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #666;
      }

      .status-indicator.connected {
        background: #4caf50;
        box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
      }

      .status-indicator.disconnected {
        background: #f44336;
      }

      .event-count {
        color: #888;
        font-size: 13px;
      }

      .controls {
        display: flex;
        gap: 10px;
      }

      button {
        padding: 8px 16px;
        background: #222;
        color: #fff;
        border: 1px solid #444;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
      }

      button:hover {
        background: #333;
        border-color: #555;
      }

      button:active {
        background: #1a1a1a;
      }

      .timeline {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .event {
        background: #151515;
        border: 1px solid #2a2a2a;
        border-radius: 6px;
        padding: 16px;
        transition: all 0.2s;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .event:hover {
        border-color: #3a3a3a;
        background: #1a1a1a;
      }

      .event-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .event-meta {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .event-type {
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .event-type.original_request {
        background: #1e3a5f;
        color: #64b5f6;
      }

      .event-type.final_request {
        background: #0d47a1;
        color: #90caf9;
      }

      .event-type.original_response {
        background: #1b5e20;
        color: #81c784;
      }

      .event-type.final_response {
        background: #0d5302;
        color: #a5d6a7;
      }

      .event-type.stream_progress {
        background: #4a148c;
        color: #ce93d8;
      }

      .event-type.policy_action {
        background: #e65100;
        color: #ffb74d;
      }

      .event-type.error {
        background: #b71c1c;
        color: #ef5350;
      }

      .event-type.other {
        background: #424242;
        color: #bdbdbd;
      }

      .event-hook {
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 11px;
        color: #888;
      }

      .event-time {
        font-size: 12px;
        color: #666;
        font-family: 'Monaco', 'Menlo', monospace;
      }

      .event-summary {
        color: #e0e0e0;
        font-size: 14px;
        margin-bottom: 8px;
      }

      .event-call-id {
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 11px;
        color: #666;
        padding: 4px 8px;
        background: #0a0a0a;
        border-radius: 3px;
        display: inline-block;
      }

      .event-payload {
        margin-top: 10px;
        padding: 10px;
        background: #0a0a0a;
        border-radius: 4px;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 11px;
        color: #999;
        display: none;
      }

      .event.expanded .event-payload {
        display: block;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state-text {
        font-size: 16px;
        margin-bottom: 8px;
      }

      .empty-state-hint {
        font-size: 13px;
        color: #555;
      }

      .ml-auto {
        margin-left: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Global Activity Stream</h1>
        <p class="subtitle">Live view of all requests and responses flowing through the proxy</p>
      </header>

      <div class="status-bar">
        <div class="status-item">
          <div class="status-indicator" id="connection-status"></div>
          <span id="connection-text">Connecting...</span>
        </div>
        <div class="status-item">
          <span class="event-count" id="event-count">0 events</span>
        </div>
        <div class="controls ml-auto">
          <button id="clear-btn">Clear</button>
          <button id="pause-btn">Pause</button>
        </div>
      </div>

      <div class="timeline" id="timeline">
        <div class="empty-state">
          <div class="empty-state-icon">ðŸ“¡</div>
          <div class="empty-state-text">Waiting for activity...</div>
          <div class="empty-state-hint">Make a request through the proxy to see events appear here</div>
        </div>
      </div>
    </div>

    <script>
      const state = {
        eventSource: null,
        events: [],
        paused: false,
        maxEvents: 100,
      };

      const elements = {
        timeline: document.getElementById('timeline'),
        connectionStatus: document.getElementById('connection-status'),
        connectionText: document.getElementById('connection-text'),
        eventCount: document.getElementById('event-count'),
        clearBtn: document.getElementById('clear-btn'),
        pauseBtn: document.getElementById('pause-btn'),
      };

      function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString('en-US', {
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          fractionalSecondDigits: 3
        });
      }

      function truncateCallId(callId) {
        if (!callId || callId === 'unknown') return 'unknown';
        return callId.length > 12 ? callId.substring(0, 12) + '...' : callId;
      }

      function formatEventType(eventType) {
        // Convert snake_case to readable format
        return eventType.replace(/_/g, ' ');
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function renderEvent(event) {
        const eventEl = document.createElement('div');
        eventEl.className = 'event';

        const typeClass = event.event_type || 'other';
        const typeLabel = formatEventType(typeClass);

        // Build DOM structure safely without innerHTML to prevent XSS
        const header = document.createElement('div');
        header.className = 'event-header';

        const meta = document.createElement('div');
        meta.className = 'event-meta';

        const typeSpan = document.createElement('span');
        typeSpan.className = `event-type ${typeClass}`;
        typeSpan.textContent = typeLabel;

        const hookSpan = document.createElement('span');
        hookSpan.className = 'event-hook';
        hookSpan.textContent = event.hook || '';

        const callIdSpan = document.createElement('span');
        callIdSpan.className = 'event-call-id';
        callIdSpan.textContent = truncateCallId(event.call_id);

        meta.appendChild(typeSpan);
        meta.appendChild(hookSpan);
        meta.appendChild(callIdSpan);

        const timeSpan = document.createElement('span');
        timeSpan.className = 'event-time';
        timeSpan.textContent = formatTime(event.timestamp);

        header.appendChild(meta);
        header.appendChild(timeSpan);

        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'event-summary';
        summaryDiv.textContent = event.summary || 'No summary';

        const payloadDiv = document.createElement('div');
        payloadDiv.className = 'event-payload';
        payloadDiv.textContent = JSON.stringify(event.payload || {}, null, 2);

        eventEl.appendChild(header);
        eventEl.appendChild(summaryDiv);
        eventEl.appendChild(payloadDiv);

        // Click to expand/collapse payload
        eventEl.addEventListener('click', () => {
          eventEl.classList.toggle('expanded');
        });

        return eventEl;
      }

      function addEvent(event) {
        if (state.paused) return;

        state.events.unshift(event);

        // Limit stored events
        if (state.events.length > state.maxEvents) {
          state.events = state.events.slice(0, state.maxEvents);
        }

        // Clear empty state if present
        const emptyState = elements.timeline.querySelector('.empty-state');
        if (emptyState) {
          emptyState.remove();
        }

        // Add to DOM
        const eventEl = renderEvent(event);
        elements.timeline.insertBefore(eventEl, elements.timeline.firstChild);

        // Remove excess DOM elements
        while (elements.timeline.children.length > state.maxEvents) {
          elements.timeline.removeChild(elements.timeline.lastChild);
        }

        updateEventCount();
      }

      function updateEventCount() {
        const count = state.events.length;
        elements.eventCount.textContent = `${count} event${count !== 1 ? 's' : ''}`;
      }

      function clearEvents() {
        state.events = [];
        elements.timeline.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“¡</div>
            <div class="empty-state-text">Waiting for activity...</div>
            <div class="empty-state-hint">Make a request through the proxy to see events appear here</div>
          </div>
        `;
        updateEventCount();
      }

      function togglePause() {
        state.paused = !state.paused;
        elements.pauseBtn.textContent = state.paused ? 'Resume' : 'Pause';
        elements.pauseBtn.style.background = state.paused ? '#b71c1c' : '#222';
      }

      function updateConnectionStatus(status) {
        elements.connectionStatus.classList.remove('connected', 'disconnected');
        if (status === 'connected') {
          elements.connectionStatus.classList.add('connected');
          elements.connectionText.textContent = 'Connected';
        } else if (status === 'disconnected') {
          elements.connectionStatus.classList.add('disconnected');
          elements.connectionText.textContent = 'Disconnected';
        } else {
          elements.connectionText.textContent = 'Connecting...';
        }
      }

      function connectStream() {
        if (state.eventSource) {
          state.eventSource.close();
        }

        updateConnectionStatus('connecting');

        state.eventSource = new EventSource('/api/activity/stream');

        state.eventSource.onopen = () => {
          console.log('Activity stream connected');
          updateConnectionStatus('connected');
        };

        state.eventSource.onmessage = (e) => {
          try {
            const event = JSON.parse(e.data);
            addEvent(event);
          } catch (err) {
            console.error('Failed to parse event:', err, e.data);
          }
        };

        state.eventSource.onerror = (err) => {
          console.error('Activity stream error:', err);
          updateConnectionStatus('disconnected');

          // Auto-reconnect after 3 seconds
          setTimeout(() => {
            console.log('Attempting to reconnect...');
            connectStream();
          }, 3000);
        };
      }

      // Event listeners
      elements.clearBtn.addEventListener('click', clearEvents);
      elements.pauseBtn.addEventListener('click', togglePause);

      // Start streaming
      connectStream();

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (state.eventSource) {
          state.eventSource.close();
        }
      });
    </script>
  </body>
</html>
