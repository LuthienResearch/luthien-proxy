# Fly.io deployment configuration for Luthien Proxy
# Deploy with: fly launch --config deploy/fly/fly.toml
#
# Prerequisites:
# 1. Install flyctl: curl -L https://fly.io/install.sh | sh
# 2. Login: fly auth login
# 3. Create app: fly apps create luthien-proxy-demo
# 4. Create Postgres: fly postgres create --name luthien-proxy-db
# 5. Attach Postgres: fly postgres attach luthien-proxy-db
# 6. Create Redis: fly redis create --name luthien-proxy-redis
# 7. Set secrets (see below)
# 8. Deploy: fly deploy --config deploy/fly/fly.toml

app = "luthien-proxy-demo"
primary_region = "iad"

[build]
  dockerfile = "docker/Dockerfile.gateway"

[env]
  GATEWAY_PORT = "8080"
  POLICY_SOURCE = "db-fallback-file"
  POLICY_CONFIG = "/app/config/policy_config.yaml"
  LOG_LEVEL = "INFO"
  OTEL_ENABLED = "false"
  ENVIRONMENT = "production"
  SERVICE_NAME = "luthien-proxy"

[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1
  processes = ["app"]

  [http_service.concurrency]
    type = "connections"
    hard_limit = 100
    soft_limit = 80

[[vm]]
  memory = "1gb"
  cpu_kind = "shared"
  cpus = 1

[checks]
  [checks.health]
    grace_period = "10s"
    interval = "30s"
    method = "GET"
    path = "/health"
    port = 8080
    timeout = "5s"
    type = "http"

# Required secrets (set via `fly secrets set`):
# fly secrets set PROXY_API_KEY="your-secure-api-key"
# fly secrets set ADMIN_API_KEY="your-secure-admin-key"
# fly secrets set OPENAI_API_KEY="sk-..."
# fly secrets set ANTHROPIC_API_KEY="sk-ant-..."
# DATABASE_URL is auto-set when attaching Postgres
# REDIS_URL is auto-set when attaching Redis
